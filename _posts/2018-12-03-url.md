---
layout: post
title:  "诡异的websocket问题"
date:   2018-12-03 16:45:00 +0800
categories: web
tag: web
---
* content
{:toc}








# Websocket问题
使用websocket替代轮询方案，场景是客服系统。但是出现了两个问题
1 客服接入量明显减少（客服是按照接入量算钱的直接关系到rmb）
2 测试中发现有些手机websocket会直接断开，但是没有onclose回调，苦恼的是跟机型无关


## 分析
第一个问题：由于一直使用chrome模拟手机和手头的两部手机iPhone + 魅族5.1 一直无法复现问题，直到基友的iPhone 5s复现了 ，之前一直猜想是不是手机版本太低，导致不支持websocket，这回可是iPhone
没道理不支持，返回码我还记得1006，无法分析啊。直到我把两个websocket字串拿出来对比 ，其中一个是正常的，原来是url转的有问题，json转过来的有特殊字符，直接拼接的没有问题。
第二个问题：翻墙 google了下，发现不少人遇到这个问题，socket close了但是没有回调。这个很让人苦恼。解决办法也比较暴力简单，加心跳。


## 解决
1.使用encodeURI对url进行处理。我接触前端不是很久，也是网上找的办法。我很奇怪的是chrome没有问题 自动处理了。
2.添加心跳，onopen中开启个定时器，发送心跳，服务器返回，如果一段时间发现收不到返回了，判断已经断开，手动onclose(3001)错误码要大于3000然后界面提示。


欢迎交流 feiqiyun@126.com

